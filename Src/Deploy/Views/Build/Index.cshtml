@model Deploy.Controllers.BuildController.Model

@section head
{
    <script src="@Url.Content("~/Scripts/pollr.js")" type="text/javascript"></script>
    <script type="text/javascript">
        function parseJsonDate(jsonDate) {
            var match, myregexp;
            myregexp = /\/Date\((-?\d+)(\+\d{4})?\)\//i;
            match = myregexp.exec(jsonDate);
            if (match != null) {
                return new Date(parseInt(match[1]));
            } else {
                return jsonDate;
            }
        }

        $(document).ready(function() {

            $('#deployButton').click(function() {
                $('#deployButton').css('visibility', 'hidden');
                $('#messagesContainer').css('visibility', 'visible');

                $.endpoint.start();
                $.endpoint.subscribe('@Model.Project.Id', '@Model.BuildInformation.Build.Id', function(message) {
                    console.log(message);
                    var messages = $('#messages')[0];
                    messages.innerHTML += parseJsonDate(message.data.Time) + ': ' + message.data.Data + '<br />';
                });

                $.ajax('@Url.Action("Deploy", "Build")',
                    {
                        type: "POST",
                        data: {
                            projectId: '@Model.Project.Id',
                            buildId: '@Model.BuildInformation.Build.Id'
                        },
                        success: function() {
                        },
                        error: function() {
                            $('#messages').innerHTML = '<span style="color: red;">Error happened when calling service.</span>';
                        }
                    });
            });
        });
    </script>
}

<table class="project">
    <tr>
        <th colspan="2">
            <span>Build: #@Model.BuildInformation.Build.Number - @Model.Project.Name</span>
            <span style="float: right">
                <a id="deployButton" href="#">Deploy</a>
                @*@Html.ActionLink("Deploy", "Deploy", new { projectId = Model.Project.Id, buildId = Model.BuildInformation.Build.Id })*@
            </span>
        </th>
    </tr>
    <tr>
        <td width="100">Procedure type</td>
        <td>@Model.Project.ProcedureType</td>
    </tr>
    <tr>
        <td colspan="2">
            @if(Model.BuildInformation.Changes.Count > 0)
            {
                <table width="100%">
                    <tr>
                        <th width="200">Username</th>
                        <th>Comment</th>
                    </tr>
                    @foreach (var change in Model.BuildInformation.Changes)
                    {
                        <tr>
                            <td width="200">@change.Username</td>
                            <td>@change.Comment</td>
                        </tr>
                    }
                </table>
            }
            else
            {
                <p>No changes in build.</p>
            }
            <table id="messagesContainer" style="visibility: hidden" width="100%">
                <tr>
                    <th>Messages</th>
                </tr>   
                <tr>
                    <td>
                        <div id="messages"></div>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>